# This name will show up in the GitHub Actions tab
name: Electron Build and Release

# This workflow runs when a new tag starting with "v" (e.g., "v1.0.0") is pushed
on:
  push:
    tags: ["v*"]

jobs:
  # JOB 1: Build the app on all 3 platforms
  build-release-artifacts:
    # Run this job only if the trigger was a tag push
    if: startsWith(github.ref, 'refs/tags/v')
    
    # Use a matrix strategy to run this job on all 3 major OSs
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        # Use 'ci' for faster, more reliable installs in CI environments
        run: npm ci

      - name: Build Electron App
        # This command (from your package.json) should build the app
        run: npm run dist

      # This step uploads ONLY the final installer file from this OS
      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          # Creates a unique artifact for each OS, e.g., "windows-latest-installer"
          name: ${{ matrix.os }}-installer
          # Use a multi-line path to grab all relevant installer/blockmap files
          path: |
            release/*.exe
            release/*.exe.blockmap
            release/*.dmg
            release/*.dmg.blockmap
            release/*.AppImage
            release/*.AppImage.blockmap
          # This prevents errors if .exe isn't found on macOS, etc.
          if-no-files-found: ignore
          retention-days: 7 # Keep artifacts for 7 days

  # JOB 2: Create the final GitHub Release
  publish-release:
    # Run this job only if the trigger was a tag push
    if: startsWith(github.ref, 'refs/tags/v')
    
    # Run this job on a single ubuntu runner
    runs-on: ubuntu-latest
    
    # This job MUST wait for all matrix builds in the previous job to finish
    needs: build-release-artifacts
    
    # Grant permissions for the 'softprops/action-gh-release' action to create a release
    permissions:
      contents: write

    steps:
      # Download all the installer artifacts saved by the 'build-release-artifacts' job
      - name: Download all installers
        uses: actions/download-artifact@v4
        with:
          # No 'name' specified = download all artifacts from this workflow run
          # They will be saved in subfolders (e.g., 'windows-latest-installer/')
          path: installers

      # This action creates the GitHub Release and uploads the files
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          # Upload all files from all subdirectories inside 'installers'
          files: |
            installers/**/*.exe
            installers/**/*.exe.blockmap
            installers/**/*.dmg
            installers/**/*.dmg.blockmap
            installers/**/*.AppImage
            installers/**/*.AppImage.blockmap
        env:
          # This token is automatically provided by GitHub Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}